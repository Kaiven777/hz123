name: Cloudflare Worker Ultimate Fix

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production

    steps:
      # 步骤1: 独立安装最新稳定版Wrangler
      - name: Install Wrangler
        run: |
          npm install -g wrangler@3.19.0 --prefix=$HOME/.local --legacy-peer-deps --no-audit
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          wrangler --version

      # 步骤2: 生成强化版配置文件
      - name: Create config
        run: |
          cat << EOF > wrangler.toml
          name = "bpb-worker"
          main = "_worker.js"
          compatibility_date = "$(date +'%Y-%m-%d')"
          node_compat = true
          [build]
          command = "echo 'No build required'"
          EOF

      # 步骤3: 部署核心逻辑
      - name: Deploy to Cloudflare
        shell: bash
        run: |
          # 设置认证信息
          export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          
          # 执行部署命令
          wrangler pages deploy _worker.js \
            --project-name=YOUR_PROJECT_NAME \
            --branch=main \
            --commit-dirty=true \
            --verbose \
            --log-level=debug

          # 部署验证
          wrangler pages list --project-name=YOUR_PROJECT_NAME
