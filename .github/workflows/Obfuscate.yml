name: Cloudflare Worker Final Fix

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 关键修复：独立环境变量管理
      - name: Setup Environment
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "CLOUDFLARE_API_TOKEN=$CLOUDFLARE_API_TOKEN" >> $GITHUB_ENV
          echo "CF_ACCOUNT_ID=$CF_ACCOUNT_ID" >> $GITHUB_ENV

      # 安装并验证Wrangler
      - name: Install Wrangler
        run: |
          npm install -g wrangler@3.19.0 --prefix=$HOME/.local --legacy-peer-deps
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          wrangler --version

      # 部署核心步骤
      - name: Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CF_ACCOUNT_ID }}
        run: |
          # 验证环境变量
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "❌ 环境变量未设置：CLOUDFLARE_API_TOKEN"
            exit 1
          fi

          # 执行部署
          wrangler pages deploy _worker.js \
            --project-name=your-project-name \
            --account-id=$CLOUDFLARE_ACCOUNT_ID \
            --branch=main \
            --commit-dirty \
            --verbose
