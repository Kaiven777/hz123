name: Cloudflare Worker 100% Working

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 步骤1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2: 直接传递环境变量（关键修复）
      - name: Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # 安装最新稳定版Wrangler
          npm install -g wrangler@3.19.0 --legacy-peer-deps
          
          # 验证环境变量
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "❌ 错误：CLOUDFLARE_API_TOKEN未设置"
            echo "请前往仓库Settings → Secrets → Actions添加对应Secret"
            exit 1
          fi

          # 执行部署命令
          wrangler pages deploy _worker.js \
            --project-name=YOUR_PROJECT_NAME \
            --account-id=$CLOUDFLARE_ACCOUNT_ID \
            --branch=main \
            --commit-dirty
